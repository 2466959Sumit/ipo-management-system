<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="layout/head :: head('Admin Allotment')"></th:block>
<body class="app-bg">

<div th:replace="layout/nav :: navbar"></div>

<div class="container app-shell">
    <div class="app-card p-4 p-md-5 app-fade-up">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-4">
            <div>
                <h3 class="app-section-title mb-1">Allotment Admin</h3>
                <div class="app-muted">Close IPOs, run allotment lottery, and view results.</div>
            </div>
            <a class="btn btn-outline-dark btn-app" th:href="@{/admin/dashboard}">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
        </div>

        <!-- Tabs header -->
        <ul class="nav nav-pills mb-3" id="allotmentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="open-tab"
                        type="button"
                        role="tab"
                        data-bs-toggle="tab"
                        data-bs-target="#open-pane"
                        aria-controls="open-pane"
                        aria-selected="true">
                    OPEN
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="closed-tab"
                        type="button"
                        role="tab"
                        data-bs-toggle="tab"
                        data-bs-target="#closed-pane"
                        aria-controls="closed-pane"
                        aria-selected="false">
                    CLOSED
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="allotted-tab"
                        type="button"
                        role="tab"
                        data-bs-toggle="tab"
                        data-bs-target="#allotted-pane"
                        aria-controls="allotted-pane"
                        aria-selected="false">
                    ALLOTTED
                </button>
            </li>
        </ul>

        <!-- Tabs content -->
        <div class="tab-content" id="allotmentTabsContent">

            <!-- OPEN -->
            <div class="tab-pane fade show active" id="open-pane" role="tabpanel" aria-labelledby="open-tab" tabindex="0">
                <div th:if="${openIpos == null || #lists.isEmpty(openIpos)}" class="alert alert-info mb-0">
                    No OPEN IPOs.
                </div>

                <div th:if="${openIpos != null && !#lists.isEmpty(openIpos)}" class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Company</th>
                            <th>Open</th>
                            <th>Close</th>
                            <th class="text-end">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="ipo : ${openIpos}">
                            <td class="fw-semibold" th:text="${ipo.ipoId}"></td>
                            <td th:text="${ipo.company != null ? ipo.company.companyName : 'N/A'}"></td>
                            <td th:text="${ipo.openDate}"></td>
                            <td th:text="${ipo.closeDate}"></td>
                            <td class="text-end">
                                <form th:action="@{/admin/ipos/{id}/close(id=${ipo.ipoId})}" method="post" class="d-inline">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn btn-sm btn-warning btn-app" type="submit" data-loading="true">
                                        <i class="bi bi-lock me-1"></i>Close IPO
                                    </button>
                                </form>
                                <a class="btn btn-sm btn-outline-dark btn-app ms-1"
                                   th:href="@{/ipos/{id}(id=${ipo.ipoId})}">
                                    View
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLOSED -->
            <div class="tab-pane fade" id="closed-pane" role="tabpanel" aria-labelledby="closed-tab" tabindex="0">
                <div th:if="${closedIpos == null || #lists.isEmpty(closedIpos)}" class="alert alert-info mb-0">
                    No CLOSED IPOs.
                </div>

                <div th:if="${closedIpos != null && !#lists.isEmpty(closedIpos)}" class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Company</th>
                            <th class="text-end">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="ipo : ${closedIpos}">
                            <td class="fw-semibold" th:text="${ipo.ipoId}"></td>
                            <td th:text="${ipo.company != null ? ipo.company.companyName : 'N/A'}"></td>
                            <td class="text-end">
                                <form th:action="@{/admin/ipos/{id}/allot(id=${ipo.ipoId})}" method="post" class="d-inline">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn btn-sm btn-dark btn-app" type="submit" data-loading="true">
                                        <i class="bi bi-shuffle me-1"></i>Run Allotment
                                    </button>
                                </form>
                                <a class="btn btn-sm btn-outline-dark btn-app ms-1"
                                   th:href="@{/ipos/{id}(id=${ipo.ipoId})}">
                                    View
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ALLOTTED -->
            <div class="tab-pane fade" id="allotted-pane" role="tabpanel" aria-labelledby="allotted-tab" tabindex="0">
                <div th:if="${allottedIpos == null || #lists.isEmpty(allottedIpos)}" class="alert alert-info mb-0">
                    No ALLOTTED IPOs.
                </div>

                <div th:if="${allottedIpos != null && !#lists.isEmpty(allottedIpos)}" class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Company</th>
                            <th class="text-end">Result</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="ipo : ${allottedIpos}">
                            <td class="fw-semibold" th:text="${ipo.ipoId}"></td>
                            <td th:text="${ipo.company != null ? ipo.company.companyName : 'N/A'}"></td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary btn-app"
                                   th:href="@{/admin/ipos/{id}/allotment-result(id=${ipo.ipoId})}">
                                    <i class="bi bi-graph-up me-1"></i>View Result
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </div>
</div>
<script>
    console.log("bootstrap:", window.bootstrap);
</script>
</body>
</html>