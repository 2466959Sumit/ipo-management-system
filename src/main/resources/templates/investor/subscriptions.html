<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="layout/head :: head('My Subscriptions')"></th:block>
<body class="app-bg">

<div th:replace="layout/nav :: navbar"></div>

<div class="container app-shell">
    <div class="app-card p-4 p-md-5 app-fade-up">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-4">
            <div>
                <h3 class="app-section-title mb-1">My Subscriptions</h3>
                <div class="app-muted">Track status, allotment and refund results.</div>
            </div>
            <a class="btn btn-warning btn-app" th:href="@{/ipos}">
                <i class="bi bi-search me-1"></i>Explore IPOs
            </a>
        </div>

        <div th:if="${cancelError}" class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span th:text="${cancelError}"></span>
        </div>

        <div th:if="${subs == null || #lists.isEmpty(subs)}" class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-1"></i>No subscriptions yet.
        </div>

        <div th:if="${subs != null && !#lists.isEmpty(subs)}" class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>IPO</th>
                    <th>Category</th>
                    <th>Qty</th>
                    <th>Paid</th>
                    <th>Status</th>
                    <th>Allotted</th>
                    <th>Refund</th>
                    <th class="text-end">Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="s : ${subs}">
                    <td class="fw-semibold" th:text="${s.subscriptionId}"></td>
                    <td>
                        <a th:href="@{/ipos/{id}(id=${s.ipo.ipoId})}" class="link-dark fw-semibold text-decoration-none">
                            IPO #<span th:text="${s.ipo.ipoId}"></span>
                        </a>
                    </td>
                    <td>
                        <span class="badge text-bg-light border" th:text="${s.investorCategory}"></span>
                    </td>
                    <td th:text="${s.quantity}"></td>
                    <td th:text="${s.amountPaid}"></td>

                    <td>
                        <span class="badge"
                              th:classappend="${s.status.name()=='SUCCESS'} ? ' text-bg-success' :
                                              (${s.status.name()=='CANCELLED'} ? ' text-bg-secondary' : ' text-bg-danger')"
                              th:text="${s.status}">
                        </span>
                    </td>

                    <td>
                        <span th:if="${allotmentsBySubId[s.subscriptionId] != null}"
                              class="fw-semibold"
                              th:text="${allotmentsBySubId[s.subscriptionId].sharesAllotted}"></span>
                        <span th:if="${allotmentsBySubId[s.subscriptionId] == null}" class="text-muted">-</span>
                    </td>

                    <td>
                        <span th:if="${allotmentsBySubId[s.subscriptionId] != null}"
                              class="fw-semibold"
                              th:text="${allotmentsBySubId[s.subscriptionId].refundAmount}"></span>
                        <span th:if="${allotmentsBySubId[s.subscriptionId] == null}" class="text-muted">-</span>
                    </td>

                    <td class="text-end">
                        <form th:if="${s.status.name() == 'SUCCESS'}"
                              th:action="@{/investor/subscriptions/{id}/cancel(id=${s.subscriptionId})}"
                              method="post" class="d-inline">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn btn-sm btn-outline-danger btn-app" type="submit">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </button>
                        </form>
                        <span th:if="${s.status.name() != 'SUCCESS'}" class="text-muted">-</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>

</body>
</html>